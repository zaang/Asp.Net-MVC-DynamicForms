Asp.Net MVC  动态表单模板 计划
==============================

##一、计划背景 ##
最初的想法，找到一种动态操作的表单模型，替代现有的OA系统的表单生成器。
希望从Asp.Net Forms 模型 切换到  Asp.Net MVC 框架。
批量处理的复杂表单，完成增、删、改、查询等功能，这可能是一个比较复杂的工作。
通常这类表单的处理工作需要一个一个的单独处理，编制强类型的数据模型、控制器和视图/展现模板。

###1.1 现行系统运行机制###
 1.  定义表单,字段名把、标题、数据类型、展现格式、引用方法等
 - 在数据库中 生成数据表结构，建立对应的数据表
 - 定义展现规则，包括 编辑控件、引用关系、关联子表特征
 - 生成对应的 aspx 页面，根据表单定义实现数据查询功能

现行系统从表单定义开始，到自动建表，已经形成了一套较为完整的业务规则，这也是多年生产实践的成果。


###1.2 现行系统的问题###
现行系统运行基本正常，但效率比较低，无法适应大规模用户访问，页面响应等待时间较长，用户体验较差，另外无法实现多版本并行化。

1. 整体层次结构

 - 系统分层结构不清晰。由于系统层次划分不清，导致在表示层（aspx）部分承担了太多的任务
 - 性能问题, Web Service 技术本身的性能损失。Web Service 适合在系统边界提供外部系统的访问，而不适宜在内部大量使用。
 - 分层不清导致无法抽象出中间体，导致无法产生页面生成模板这样的中间体用于缓存规则和提高性能
 - 分层不清晰导致无法使用使用多级缓存技术

2. 版本控制，不支持多版本并行

3. 数据处理方式

 - 数据处理采用 .Net 2.0 框架中的 弱类型 DataSet/DataTable 作为数据容器。
这种方法具备相当的灵活性，可以容纳数据表的变化，并且能够动态绑定表示层。
 - DataSet 和XML数据本身是想通的，即可以从 DataSet转换为XML ，同时也可以由DataSet 对象读取 XML数据完成数据集填充。
所以可以说实际上使用的是XML的一个变种，既可以严格限定数据字段也可以随时容纳字段和结构的变化。
虽然DataSet 访问起来很快但是这种自由访问是需要代价的，比如数据集中的检索速度取决于是否存在主键和索引，强类型的DataSet通常在填充阶段就已经准备好了主键索引，所以根据主键进行查找会非常快，而弱类型的DataSet就不会有这种优势。
 - 自定义的数据表还提供了一项优惠，即可以根据任意字段进行关联建立索引和视图，这一点是XML无法提供的。

###1.3 多版本并行问题###
多版本问题一直影响产品的实施，在产品的生命周期中，一个表单会进行多次修改，虽然这些修改不会有太多的改变，但是每一次都需要小心翼翼的修订和验证很多地方。
如果采用XML结构进行处理，每个表单都是独立的结构，映射到对应版本的展现模板，表单存档后内容自包含引用数据，数据状态得到保留，代码表更新不会影响存档数据。
关系型数据库的约束规则会优化存储空间，提高查询性能，但是愈来愈复杂的关联结构无法用外键表示，表结构也会不断变化，这势必导致系统的整体退化，长期运营的结果必然是补丁摞补丁，难以维护。

###1.4 需要解决的问题优先级###
综上所述，新的模型需要解决的问题优先级别
1. 多版本并行
2. 中间体/显示模板
3. 索引和查询功能

##二、Web 表单模型 ##
### 2.1 Web 表单模型 ###
- Web 表单模型包括 
  - 模型定义
  - 数据存储模型
  - 视图模型 （View Model ）
  - 业务规则
  - 关联数据、外部引用
  - 数据展现模板（新增模板、编辑模板、列表模板、明细查看模板、打印输出模板（Web 打印））
  - 数据验证规则
  - 数据过滤规则
  
 *分得这么详细，让我想起了 Share Point*

- 表单数据处理业务逻辑包括
  - 版本控制
  - 模板定义
  - 视图模板自动生成
  - 流程控制
  - 工作流集成 （各个业务处理环节需要的数据各不相同，数据展现和 View Model 也不同）

### 2.2 表单模板 ###
1. 表单模板按照多版本并行和功能要求会有多个版本共存，我们关心的问题是
 - 模板处理机制
 - 语法结构是否清晰，能否处理复杂的用户界面逻辑
 - 能否自动生成和部署
 - 运行效能
 - 是否有可供评估的具体实例
 - 是否支持编辑辅助提示和开发阶段单元测试，提高生产率
 
2. 按照模板处理的方式可以分为
  - 动态编译执行 （可以内嵌业务逻辑）
  - 解释过滤（用文本操作文本）

3. 按照数据绑定处理位置可以分为
 - 客户端合成（MVVC 模式/客户端数据绑定）
 - 服务器端合成 （数据后台绑定）

4. Web 表单模板运行环境
 - Web 表单运行在 Web容器之中，具体说在HTML Form 标签之内，模板仅需要定义显示的方式和处理标记
 - 脚本接口规范
 - 上下文环境
 - 模板路由约定，一个表单在不同的处理阶段（业务流程）会有各自的显示方式，那么就要能够动态加载模板，这里采取 **约定大于配置** 的原则进行处理，根据命名规则约定直接加载。

5. Web 表单模板不包括什么
 - 页面布局
 - 样式
 - 上下文信息 （Cookie和View States 等）
 - 


##三、技术准备 ##
###3.1 XML 技术###


###3.2 NoSQL 技术###
NoSQL 不仅仅表示使用 MangoDB 等数据存储方案，而是从设计上跳出以依赖 RDBMS 作为唯一数据存储手段的设计思想，从系统整体需求上设计存储方式，NoSQL 可以理解为 Not Only SQL。NoSQL是 面向对象设计和SQL方法不可调和矛盾产生的。
应当说，NoSQL不是要摒弃 RDBMS 而是摒弃了程序代码中的 SQL，把数据存储层独立出来，让系统可以不依赖任何一种存储实现。
那么如果按照以上的说法就不能依赖 RDBMS 提供的性能红利，而是从系统实体模型上实现优化。
简单的说，系统性能问题不能依靠更庞大的数据库系统来实现，在云计算环境，每一个分层都可能会被无情的拆解到分布式计算环境中，以带来服务级别的提升。

** “面向聚合的数据库能够兴起，很大程度上是由于集群的增长。运行在集群环境中的数据库对数据存储问题的权衡方式与单机环境有所不同。集群不仅改变了数据存储规则，而且改变了数据计算规则。如果把大量数据放在集群里，那么为了有效处理数据，你必须以另外一种思路来考虑如何安排数据处理流程。 *
** 当把数据库放到集群后，立刻带来一个好处：把运算工作分布到多台计算机中去。然而此时仍要试着减少通过网络传输的数据量，把某个节点所需的数据尽可能多的放在节点执行。 ” *

NoSQL 虽然有很多种实现，其原理都是存储 键值对，也就是关系型数据库中的（主键/表值）结构。
NoSQL的功能初看起来远远不如RDBMS功能强大。

问题分析
1. 键值对如何设计索引，索引也是一个**键值对**


###3.3 JavaScript / JSON ###
JSON(JavaScript Object Notation) 是一种轻量级的数据交换格式。 易于人阅读和编写。
和XML相比，JSON 更适合客户端浏览器的使用，避免了从客户端解析XML的复杂操作。
JSON作为Javascript语言表示数据的方法，支持多层实体嵌套。

MongoDB 提供了一种性能强劲的文档数据库实现，特别的是Mongo 采用的是JSON方式存取数据。
Mongo 提示了我们一个重要的问题，我们一直在数据库、SQL、文本、实体对象和JSON之间打转，需要太多的精力去来回转换它们，系统的复杂性由此产生。
假设从数据存储到服务器查询直到Web界面展示一直都采取一种方式，即Javascript 的方式执行，各个层级之间就无需反复的进行数据转换和对象绑定，必定能够大幅度提高性能和代码的复用。
排除性能损失的问题，在表单处理的各个阶段我们都需要不同的技术手段，有一些是我们很熟悉的，而另外一些比较陌生，这些都不是确定技术方案的主要依据，一致化的处理方法带来相同的语境和技能交流和提升。
针对数据（JSON）的操作既可以放在服务器端，也可以提供给客户端进行处理，或者说，在测试环境中就可以完成数据操作的测试，而不用在浏览器里进行。
纯JS 的解决方案可以使用NodeJS，不过个人认为混搭的系统环境，用适合的方法去做擅长的事情比较适合。

### 3.4 Razor视图引擎 ###
 从 Asp.Net MVC 3 发布开始使用一种 Razor视图引擎。
 规则非常简单
 
  1. **@** 后面的部分为 C# 代码
  2. 通过 **{ ...  }** 支持多行C#代码
  
 `
 1 <!-- 简单块 声明两个变量-->
 2 @{int num = 10;}
 3 @{string str = "hello cnblogs";}
 4 <!-- 内联表达式 输入刚才声明的两个变量-->
 5 <p>刚才声明的整形的值为： @num</p>
 6 <p>刚才声明的字符型的值为： @str</p>
 7 
 8 <!-- 多声明代码块 -->
 9 @{
10     string strHello = "您好，我叫李亮";
11     string now = DateTime.Now.ToString();
12     string sayHello = strHello + "当前时间为：" + now;
13  }
14  <p>问好: @sayHello</p>
 `
 
 
##四、目前能够确定的和需要讨论的事项 ##
能够确定的是

 - 表单定义部分可以继续使用
 - 基于 MVC 框架 进行服务器端开发
 - 多层结构的系统架构
 - 必须满足多版本并行需求
 - 根据表单定义自动生成的表单模板
 - 表单模板支持手工编辑
 - 优先考虑大家熟悉的技术手段，但不能排除新技术的引入
 - 表单模板的技术方向决定系统整体方向，其他部分需要围绕这个中心进行调整

暂时无法确定的是

 - 表单处理模板技术选择 决定整体技术方向


静态表单模板实现方式
1. 客户端数据绑定
2. 自定义客户端数据验证属性声明
3. 表单模板的表示方法
3. 表单模板编辑器（在表单定义后需要手动定制一些内容，类似报表编辑器的功能）


> Written with [StackEdit](https://stackedit.io/).